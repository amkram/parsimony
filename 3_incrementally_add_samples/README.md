# incrementally add samples

In this directory, we separate the files from our data-set by the date that the sample was taken. We then organize these dates into batches, such that each batch contains roughly 5,000 samples. The goal here is to model the phylogenetic data accumulation that occurred over the course of the pandemic, using both parsimony- and ML-based strategies.

# Setup

#### First, download metadata file that contains dates for each sample, sort the samples by date, and create VCFs and MSAs for each batch.
```
wget https://hgwdev.gi.ucsc.edu/~angie/UShER_SARS-CoV-2/2021/03/18/public-2021-03-18.metadata.tsv.gz  
python getMetadata.py  
mkdir BATCH_SAMPLES/
python getBatches.py  
mkdir BATCH_VCFs/
bash getVCFs.sh
mkdir BATCH_FASTAS/
python makeFastas.py
```

#### Test UShER and matUtils tree-building and optimization:
```
mkdir INCREMENTAL_PBS/
bash makeTreesMatOptimizeParsimony.sh # This script adds each batch in order, optimizing after each step with matOptimize, and logging each optimization step.
```

#### After 50 batches have finished, extract trees and compress files:
```
parallel -j 12 < extractTrees.sh  
tar cfJ opt.pbs.tar.xz *.opt.pb  
tar cfJ opt.nwk.tar.xz *.opt.nwk  
```
# Results

## 3.1: Online IQ-TREE 2

```
bash makeTrees.sh  
bash getLikelihoods.sh  
```

| Iteration | Total Sequences | Threads | Wall Clock Time | RAM (kB) | Parsimony | LogLk |  
|-----------|-----------------|---------|-----------------|----------|-----------|-------|  
| 1 | 4676 | 15 | 0h:5m:52s | 5614036 | 3038 | -76866.020 |
| 2 | 8902 | 15 | 0h:18m:54s | 15315684 | 5544 | -106894.732 |
| 3 | 13241 | 15 | 0h:41m:15s | 28480576 | 8081 | -137249.474 |
| 4 | 17941 | 15 | 1h:07m:13s | 42748580 | 10912 | -171084.153 |
| 5 | 22012 | 15 | 0h:59m:59s | 56679440 | 13385 | -200572.594 |
| 6 | 26486 | 15 | 1h:45m:55s | 72230144 | 16179 | -233945.528 |
| 7 | 30989 | 15 | 2h:23m:55s | 87785860 | 19014 | -267685.310 |
| 8 | 35323 | 15 | 3h:43m:35s | 103261628 | 22066 | -304030.701 |
| 9 | 39621 | 15 | 4h:00m:15s | 120021168 | 25542 | -345029.484 |
| 10 | 43808 | 15 | 4h:41m:36s | 136283068 | 28813 | -383663.174 |
| 11 | 47819 | 15 | 5h:26m:46s | 152075844 | 32005 | -421088.581 |
| 12 | 51899 | 15 | 6h:19m:47s | 169233028 | 36309 | -470863.963 |
| 13 | 56308 | 15 | 6h:59m:25s | 185841820 | 40128 | -515365.033 |
| 14 | 60571 | 15 | 8h:10m:01s | 201592592 | 43719 | -557131.747 |  

#### 15th phylogeny prematurely terminated due to RAM requirements.   

## 3.2: de novo IQ-TREE 2

```
bash makeTrees.sh  
bash getParsimony.sh  
bash getLikelihoods.sh    
```

| Iteration | Total Sequences | Threads | Wall Clock Time | RAM (kB) | Parsimony | LogLk |  
|-----------|-----------------|---------|-----------------|----------|-----------|-------|
| 1 | 4676 | 15 | 0h:10m:17s | 5614840 | 3029 | -76784.557 |  
| 2 | 8902 | 15 | 0h:41m:48s | 15319264 | 5533 | -106806.904 |  
| 3 | 13241 | 15 | 1h:29m:47s | 28480608 | 8074 | -137243.477 |  
| 4 | 17941 | 15 | 2h:58m:46s | 42748548 | 10920 | -171294.970 |  
| 5 | 22012 | 15 | 4h:40m:48s | 56675544 | 13397 | -200883.337 |  
| 6 | 26486 | 15 | 6h:06m:08s | 72230700 | 16202 | -234395.541 |  
| 7 | 30989 | 15 | 8h:06m:16s | 87786152 | 19070 | -268587.574 |  
| 8 | 35323 | 15 | 10h:45m:25s | 103261452 | 22153 | -305309.306 |  
| 9 | 39621 | 15 | 16h:05m:42s | 120019392 | 25626 | -346310.142 |  
| 10 | 43808 | 15 | 20h:23m:29s | 136296076 | 28927 | -385354.582 |  
| 11 | 47819 | 15 | 22h:50m:20s | 152070808 | 32149 | -423130.123 |  

#### 12th phylogeny required 28h:19m:01s to complete.  

## 3.3: Online FastTree2  

```
bash makeTrees.sh  
bash getParsimony.sh  
bash getLikelihoods.sh    
```

| Iteration | Total Sequences | Threads | Wall Clock Time | RAM (kB) | Parsimony | LogLk |  
|-----------|-----------------|---------|-----------------|----------|-----------|-------|
| 1 | 4676 | 15 | 1h:20m:41s | 5172368 | 3022 | -76697.194 |  
| 2 | 8902 | 15 | 3h:48m:01s | 9684048 | 5546 | -106914.685 |  
| 3 | 13241 | 15 | 7h:27m:36s | 14797776 | 8111 | -137578.065 |  
| 4 | 17941 | 15 | 12h:44m:46s | 20388776 | 10969 | -171710.289 |  
| 5 | 22012 | 15 | 18h:16m:01s | 25124716 | 13462 | -201423.321 |  
| 6 | 26486 | 15 | 23h:50m:08s | 30258796 | 16290 | -235177.396 |  

#### 7th phylogeny required 29h:08m:42s to complete.   

## 3.4: de novo FastTree2

```
bash makeTrees.sh  
bash getParsimony.sh  
bash getLikelihoods.sh    
```

| Iteration | Total Sequences | Threads | Wall Clock Time | RAM (kB) | Parsimony | LogLk |  
|-----------|-----------------|---------|-----------------|----------|-----------|-------|  
| 1 | 4676 | 15 | 1h:24m:44s | 5177660 | 3022 | -76720.160 |  
| 2 | 8902 | 15 | 2h:40m:06s | 9662804 | 5530 | -106750.638 |  
| 3 | 13241 | 15 | 4h:29m:58s | 14710344 | 8076 | -137199.783 |  
| 4 | 17941 | 15 | 6h:31m:03s | 20209160 | 10917 | -171159.976 |  
| 5 | 22012 | 15 | 8h:06m:11s | 24933880 | 13410 | -200846.113 |  
| 6 | 26486 | 15 | 9h:56m:32s | 30010824 | 16222 | -234408.096 |  
| 7 | 30989 | 15 | 11h:42m:19s | 35066004 | 19073 | -268303.551 |  
| 8 | 35323 | 15 | 13h:42m:33s | 40165740 | 22143 | -304852.007 |  
| 9 | 39621 | 15 | 15h:42m:41s | 45235280 | 25630 | -345975.913 |  
| 10 | 43808 | 15 | 17h:46m:56s | 50092604 | 28906 | -384665.970 |  
| 11 | 47819 | 15 | 18h:58m:35s | 54813852 | 32103 | -422116.453 |  
| 12 | 51899 | 15 | 21h:41m:57s | 59518580 | 36416 | -471962.130 |  

#### 13th phylogeny required 28h:22m:06s to complete.     

## 3.5: Online matOptimize

| Iteration | Total Sequences | Threads | Wall Clock Time | RAM (kB) | Parsimony | LogLk |
|-----------|-----------------|---------|-----------------|----------|-----------|-------|
| 1 | 4676 | 15 | 0h:0m:03s | 31048 | 3438 | -76712.635 |
| 2 | 8902 | 15 | 0h:0m:08s | 58756 | 6193 | -106736.717 |
| 3 | 13241 | 15 | 0h:0m:17s | 77252 | 8876 | -137154.586 |
| 4 | 17941 | 15 | 0h:0m:30s | 112276 | 11759 | -171091.472 |
| 5 | 22012 | 15 | 0h:0m:45s | 127292 | 14263 | -200618.989 |
| 6 | 26486 | 15 | 0h:1m:06s | 139028 | 17033 | -233915.281 |
| 7 | 30989 | 15 | 0h:1m:27s | 154504 | 19771 | -267631.562 |
| 8 | 35323 | 15 | 0h:1m:55s | 169048 | 22735 | -303950.225 |
| 9 | 39621 | 15 | 0h:2m:30s | 195528 | 26124 | -344871.380 |
| 10 | 43808 | 15 | 0h:3m:06s | 200304 | 29304 | -383426.103 |
| 11 | 47819 | 15 | 0h:3m:41s | 235844 | 32430 | -420759.417 |
| 12 | 51899 | 15 | 0h:4m:23s | 279460 | 36691 | -470343.935 |
| 13 | 56308 | 15 | 0h:5m:41s | 264596 | 40472 | -514471.215 |
| 14 | 60571 | 15 | 0h:6m:45s | 305716 | 44040 | -556013.813 |
| 15 | 64666 | 15 | 0h:10m:20s | 349960 | 47190 | -592505.102 |
| 16 | 69052 | 15 | 0h:7m:57s | 375400 | 50132 | -626507.132 |
| 17 | 73231 | 15 | 0h:9m:01s | 382316 | 52859 | -658563.044 |
| 18 | 77399 | 15 | 0h:10m:31s | 345640 | 55633 | -690891.607 |
| 19 | 81802 | 15 | 0h:10m:19s | 366972 | 59032 | -729964.574 |
| 20 | 85946 | 15 | 0h:12m:42s | 465100 | 62035 | -764439.487 |
| 21 | 90062 | 15 | 0h:13m:27s | 540544 | 64694 | -794660.583 |
| 22 | 94384 | 15 | 0h:14m:56s | 439416 | 67481 | -826095.371 |
| 23 | 98578 | 15 | 0h:14m:55s | 493780 | 70073 | -855595.986 |
| 24 | 103052 | 15 | 0h:17m:32s | 496064 | 72930 | -888502.254 |
| 25 | 107441 | 15 | 0h:17m:12s | 576056 | 75883 | -922456.030 |
| 26 | 112716 | 15 | 0h:20m:05s | 548940 | 79187 | -960693.876 |
| 27 | 116999 | 15 | 0h:22m:57s | 657440 | 82320 | -997036.610 |
| 28 | 122802 | 15 | 0h:16m:35s | 542868 | 86315 | -1044334.794 |
| 29 | 128292 | 15 | 0h:16m:54s | 590880 | 89877 | -1086464.533 |
| 30 | 133990 | 15 | 0h:19m:24s | 621048 | 93987 | -1135380.054 |
| 31 | 138764 | 15 | 0h:30m:22s | 619584 | 97657 | -1178911.103 |
| 32 | 144037 | 15 | 0h:32m:52s | 831736 | 101735 | -1226790.525 |
| 33 | 149574 | 15 | 0h:35m:43s | 650908 | 106038 | -1277584.527 |
| 34 | 154358 | 15 | 0h:37m:14s | 750680 | 109618 | -1319958.684 |
| 35 | 158404 | 15 | 0h:59m:25s | 714320 | 113252 | -1362258.637 |
| 36 | 162559 | 15 | 0h:44m:45s | 796568 | 116418 | -1399471.140 |
| 37 | 166621 | 15 | 0h:39m:59s | 370128 | 119945 | -1440374.123 |
| 38 | 170826 | 15 | 0h:35m:04s | 362044 | 123928 | -1485937.509 |
| 39 | 176258 | 15 | 0h:45m:47s | 374340 | 128217 | -1535293.810 |
| 40 | 182077 | 15 | 0h:58m:33s | 409844 | 132370 | -1583581.251 |
| 41 | 187490 | 15 | 1h:01m:39s | 422708 | 136019 | -1625476.698 |
| 42 | 192049 | 15 | 1h:04m:15s | 462308 | 139229 | -1662661.248 |
| 43 | 196853 | 15 | 1h:11m:29s | 371260 | 143208 | -1707815.141 |
| 44 | 201995 | 15 | 1h:10m:43s | 425956 | 149578 | XXX |
| 45 | 207246 | 15 | 1h:28m:14s | 435100 | 154485 | XXX |
| 46 | 212424 | 15 | 1h:28m:20s | 493880 | 159974 | XXX |
| 47 | 217254 | 15 | 1h:35m:59s | 494248 | 165392 | XXX |
| 48 | 223132 | 15 | 1h:35m:29s | 481652 | 171816 | XXX |
| 49 | 227555 | 15 | 1h:24m:32s | 481828 | 176514 | XXX |
| 50 | 233326 | 15 | 2h:02m:06s | 484120 | 182075 | XXX |

## 3.6: de novo UShER+matOptimize

Currently running on root@fasttree:/mnt/FROM_SCRATCH :
re-doing timing because i only timed the optimize part instead of both

| Iteration | Total Sequences | Threads | Wall Clock Time | RAM (kB) | Parsimony | LogLk |
|-----------|-----------------|---------|-----------------|----------|-----------|-------|
| 1 | 4676 | 15 | 0h:0m:02s | 30912 | 3438 | -76714.884 |
| 2 | 8902 | 15 | 0h:0m:06s | 55076 | 6193 | -106771.327 |
| 3 | 13241 | 15 | 0h:0m:12s | 69140 | 8877 | -137179.148 |
| 4 | 17941 | 15 | 0h:0m:21s | 90884 | 11757 | -171107.534 |
| 5 | 22012 | 15 | 0h:0m:37s | 104488 | 14262 | -200743.191 |
| 6 | 26486 | 15 | 0h:0m:56s | 121284 | 17033 | -234137.959 |
| 7 | 30989 | 15 | 0h:1m:18s | 135460 | 19770 | -267885.309 |
| 8 | 35323 | 15 | 0h:1m:49s | 163604 | 22731 | -304140.908 |
| 9 | 39621 | 15 | 0h:2m:23s | 171244 | 26126 | -345098.303 |
| 10 | 43808 | 15 | 0h:3m:02s | 194420 | 29309 | -383700.837 |
| 11 | 47819 | 15 | 0h:3m:37s | 209560 | 32434 | -421073.628 |
| 12 | 51899 | 15 | 0h:4m:28s | 244124 | 36694 | -470681.472 |
| 13 | 56308 | 15 | 0h:5m:22s | 248932 | 40480 | -514854.845 |
| 14 | 60571 | 15 | 0h:7m:26s | 256600 | 44047 | -556371.031 |
| 15 | 64666 | 15 | 0h:9m:33s | 400132 | 47196 | -592849.684 |
| 16 | 69052 | 15 | 0h:10m:55s | 334224 | 50135 | -626862.603 |
| 17 | 73231 | 15 | 0h:12m:12s | 386024 | 52866 | -659000.390 |
| 18 | 77399 | 15 | 0h:13m:19 | 345752 | 55641 | -691332.307 |
| 19 | 81802 | 15 | 0h:14m:57 | 448692 | 59042 | -730423.589 |
| 20 | 85946 | 15 | 0h:16m:29s | 400492 | 62048 | -764943.167 |
| 21 | 90062 | 15 | 0h:18m:12s | 468560 | 64700 | -795107.030 |
| 22 | 94384 | 15 | 0h:19m:35s | 486844 | 67483 | -826561.213 |
| 23 | 98578 | 15 | 0h:15m:24s | 486584 | 70079 | -856016.985 |
| 24 | 103052 | 15 | 0h:17m:22s | 585856 | 72937 | -888964.640 |
| 25 | 107441 | 15 | 0h:18m:25s | 727652 | 75892 | -922940.604 |
| 26 | 112716 | 15 | 0h:20m:18s | 569240 | 79197 | -961213.277 |
| 27 | 116999 | 15 | 0h:22m:01s | 606036 | 82332 | -997593.566 |
| 28 | 122802 | 15 | 0h:23m:39s | 705752 | 86328 | -1044860.285 |
| 29 | 128292 | 15 | 0h:26m:39s | 626484 | 89888 | -1086987.413 |
| 30 | 133990 | 15 | 0h:36m:39s | 679932 | 94006 | -1135954.449 |
| 31 | 138764 | 15 | 0h:41m:04s | 702128 | 97673 | -1179437.426 |
| 32 | 144037 | 15 | 0h:44m:44s | 670808 | 101756 | -1227456.622 |
| 33 | 149574 | 15 | 0h:48m:07s | 764204 | 106057 | -1278238.351 |
| 34 | 154358 | 15 | 0h:52m:51s | 793096 | 109639 | -1320681.632 |
| 35 | 158404 | 15 | 0h:57m:00s | 708152 | 113272 | -1362890.717 |
| 36 | 162559 | 15 | 0h:59m:27s | 862584 | 116439 | -1400135.060 |
| 37 | 166621 | 15 | 1h:02m:40s | 334480 | 119965 | -1441068.133 |
| 38 | 170826 | 15 | 1h:06m:07s | 318768 | 123949 | -1486640.913 |
| 39 | 176258 | 15 | 0h:53m:30s | 334000 | 128236 | -1536000.033 |
| 40 | 182077 | 15 | 1h:00m:22s | 322744 | 132387 | -1584263.430 |
| 41 | 187490 | 15 | 0h:48m:22s | 334604 | 136039 | -1626224.080 |
| 42 | 192049 | 15 | 0h:56m:04s | 331416 | 139255 | -1663485.999 |
| 43 | 196853 | 15 | 0h:55m:11s | 349932 | 143233 | -1708613.826 |
| 44 | 201995 | 15 | 1h:11m:14s | 375556 | 149601 | -1780330.042 |
| 45 | 207246 | 15 | 1h:23m:19s | 406968 | 154512 | -1836546.353 |
| 46 | 212424 | 15 | 1h:40m:16s | 425212 | 159997 | -1899362.424 |
| 47 | 217254 | 15 | 1h:47m:26s | 458424 | 165420 | -1961331.260 |
| 48 | 223132 | 15 | 1h:56m:13s | 441104 | 171842 | -2035850.049 |
| 49 | 227555 | 15 | 1h:58m:41s | 510196 | 176540 | XXX |
| 50 | 233326 | 15 | 1h:36m:19s | 418808 | 182097 | XXX |

## 3.7: de novo UShER

| Iteration | Total Sequences | Threads | Wall Clock Time | RAM (kB) | Parsimony | LogLk |
|-----------|-----------------|---------|-----------------|----------|-----------|-------|
| 1 | 4676 | 15 | 0h:0m:06s | 22256 | 3464 | -76909.606 |
| 2 | 8902 | 15 | 0h:0m:19s | 33656 | 6247 | -107309.132 |
| 3 | 13241 | 15 | 0h:0m:40s | 40932 | 8992 | -137665.493 |
| 4 | 17941 | 15 | 0h:1m:18s | 58620 | 11866 | -182943.119 |
| 5 | 22012 | 15 | 0h:2m:05s | 64180 | 14410 | -217030.341 |
| 6 | 26486 | 15 | 0h:2m:57s | 78456 | 17191 | -253701.534 |
| 7 | 30989 | 15 | 0h:3m:59s | 84580 | 19982 | -289203.828 |
| 8 | 35323 | 15 | 0h:5m:30s | 108540 | 22877 | -326908.362 |
| 9 | 39621 | 15 | 0h:7m:16s | 112960 | 26310 | -368810.577 |
| 10 | 43808 | 15 | 0h:8m:40s | 130228 | 29467 | -408278.755 |
| 11 | 47819 | 15 | 0h:11m:47s | 131080 | 32654 | -446111.273 |
| 12 | 51899 | 15 | 0h:14m:03s | 141400 | 36957 | -496372.611 |
| 13 | 56308 | 15 | 0h:15m:49s | 147000 | 40782 | -541128.231 |
| 14 | 60571 | 15 | 0h:39m:06s | 153124 | 44374 | -583029.703 |
| 15 | 64666 | 15 | 1h:15m:52s | 156016 | 47572 | -619834.056 |
| 16 | 69052 | 15 | 1h:25m:44s | 209740 | 50530 | -653733.434 |
| 17 | 73231 | 15 | 1h:25m:43s | 217228 | 53266 | -686330.558 |
| 18 | 77399 | 15 | 1h:57m:12s | 225780 | 56086 | -718555.712 |
| 19 | 81802 | 15 | 2h:29m:53s | 230356 | 59443 | -758118.234 |
| 20 | 85946 | 15 | 2h:47m:01s | 238484 | 62452 | -792226.651 |
| 21 | 90062 | 15 | 1h:11m:41s | 247416 | 65124 | -822834.469 |
| 22 | 94384 | 15 | 0h:47m:58s | 251084 | 67951 | -854744.490 |
| 23 | 98578 | 15 | 0h:53m:52s | 261224 | 70587 | -887815.202 |
| 24 | 103052 | 15 | 3h:00m:31s | 275844 | 73474 | -921040.828 |
| 25 | 107441 | 15 | 3h:44m:44s | 278344 | 76427 | -958152.568 |
| 26 | 112716 | 15 | 2h:36m:59s | 293460 | 79741 | -998263.822 |
| 27 | 116999 | 15 | 1h:18m:52s | 305412 | 82877 | -1034857.981 |
| 28 | 122802 | 15 | 3h:10m:13s | 312084 | 86884 | -1082447.765 |
| 29 | 128292 | 15 | 5h:18m:31s | 323792 | 90474 | -1131244.316 |
| 30 | 133990 | 15 | 5h:21m:22s | 409760 | 94594 | -1183825.059 |
| 31 | 138764 | 15 | 1h:53m:06s | 423888 | 98262 | -1228247.129 |
| 32 | 144037 | 15 | XXX | XXX | 102358 | -1278013.717 |
| 33 | 149574 | 15 | XXX | XXX | 106694 | -1329698.894 |
| 34 | 154358 | 15 | XXX | XXX | 110304 | -1372642.273 |
| 35 | 158404 | 15 | XXX | XXX | 113971 | -1420412.666 | 
| 36 | 162559 | 15 | XXX | XXX | 117148 | -1458793.753 | 
| 37 | 166621 | 15 | XXX | XXX | 120711 | -1503056.342 | 
| 38 | 170826 | 15 | XXX | XXX | 125003 | -1550787.410 |
| 39 | 176258 | 15 | XXX | XXX | 129045 | -1601101.634 |
| 40 | 182077 | 15 | XXX | XXX | 133217 | -1650306.889 | 
| 41 | 187490 | 15 | XXX | XXX | 136817 | -1692531.995 | 
| 42 | 192049 | 15 | XXX | XXX | 140091 | -1730384.543 | 
| 43 | 196853 | 15 | XXX | XXX | 144059 | -1775442.052 | 
| 44 | 201995 | 15 | XXX | XXX | 150448 | -1847215.849 | 
| 45 | 207246 | 15 | XXX | XXX | 155378 | -1903819.675 | 
| 46 | 212424 | 15 | XXX | XXX | 160899 | -1967030.750 | 
| 47 | 217254 | 15 | XXX | XXX | 166352 | -2029213.347 | 
| 48 | 223132 | 15 | XXX | XXX | 172807 | -2104234.637 | 
| 49 | 227555 | 15 | XXX | XXX | 177495 | | 
| 50 | 233326 | 15 | XXX | XXX | 183098 | | 

## 3.8: RAXML-NG

| Iteration | Total Sequences | Threads | Wall Clock Time |
|-----------|-----------------|---------|-----------------|
| 1 | 4676 | 24 | 240h+ |

* The initial run, using command `/usr/bin/time -o rax1.time.txt -f "%E %M" raxml-ng --model GTR+G --msa 1.fasta --blmin 0.000000001 --threads 24`, was killed after 240 hours of wall-clock time.
